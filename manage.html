<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>卡密管理系统</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .section { margin-bottom: 30px; }
        form { margin-bottom: 20px; }
        input[type="text"], input[type="date"], select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #5cb85c; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; }
        button:hover { background-color: #4cae4c; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        button.warning { background-color: #ffc107; color: #212529; }
        button.warning:hover { background-color: #e0a800; }
        .message { text-align: center; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .nav { margin-bottom: 20px; text-align: center; }
        .nav a { margin-right: 15px; text-decoration: none; color: #007bff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/dashboard.html">生成卡密</a>
            <a href="/manage.html">管理卡密</a>
            <a href="/logs.html">使用日志</a>
            <a href="/software.html">软件管理</a>
            <a href="/admin.html" onclick="localStorage.removeItem('loggedin');">退出登录</a>
        </div>

        <div class="section">
            <h2>卡密操作</h2>
            <form id="manage-form">
                <label for="card_key">输入卡密进行操作:</label>
                <input type="text" id="card_key" placeholder="输入卡密" required>
                <label for="action">选择操作:</label>
                <select id="action" required>
                    <option value="unbind">解绑设备</option>
                    <option value="delete">删除卡密</option>
                    <option value="pause_card">暂停卡密</option>
                    <option value="activate_card">激活卡密</option>
                    <option value="extend_card">延长时长</option>
                </select>
                <button type="submit">执行操作</button>
            </form>
            <div id="manage-message"></div>
        </div>

        <div class="section">
            <h2>修改到期时间</h2>
            <form id="expiry-form">
                <label for="card_key_expiry">输入卡密:</label>
                <input type="text" id="card_key_expiry" placeholder="输入卡密" required>
                <label for="new_expiry">新的到期时间:</label>
                <input type="date" id="new_expiry" required>
                <button type="submit">修改到期时间</button>
            </form>
            <div id="expiry-message"></div>
        </div>
        
        <div class="section">
            <h2>设备管理</h2>
            <form id="device-form">
                <label for="device_id">设备ID:</label>
                <input type="text" id="device_id" placeholder="输入设备ID" required>
                <label for="device_action">选择操作:</label>
                <select id="device_action" required>
                    <option value="ban_device">封禁设备</option>
                    <option value="unban_device">解封设备</option>
                </select>
                <label for="reason">封禁原因 (封禁时必填):</label>
                <textarea id="reason" placeholder="输入封禁原因"></textarea>
                <button type="submit" id="device-submit-btn">执行操作</button>
            </form>
            <div id="device-message"></div>
        </div>
    </div>

    <script>
    if (!localStorage.getItem('loggedin')) {
        window.location.href = '/admin.html';
    }

    function showMessage(elementId, message, isSuccess) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = `message ${isSuccess ? 'success' : 'error'}`;
        setTimeout(() => { el.textContent = ''; el.className = ''; }, 3000);
    }

    // 通用提交处理
    async function handleFormSubmit(event, messageElId) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        // 特殊处理设备封禁原因
        if (data.action === 'ban_device' && !data.reason.trim()) {
            showMessage(messageElId, '封禁设备时必须填写原因', false);
            return;
        }
        if(data.action !== 'ban_device') {
            delete data.reason; // 如果不是封禁，则去掉reason字段
        }

        const response = await fetch('/admin/manage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        showMessage(messageElId, result.message, result.status === 'success');
        if (result.status === 'success') {
            event.target.reset();
        }
    }

    document.getElementById('manage-form').addEventListener('submit', (e) => handleFormSubmit(e, 'manage-message'));
    document.getElementById('expiry-form').addEventListener('submit', (e) => handleFormSubmit(e, 'expiry-message'));
    document.getElementById('device-form').addEventListener('submit', (e) => handleFormSubmit(e, 'device-message'));
    </script>
</body>
</html>
