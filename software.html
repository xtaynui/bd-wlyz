<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>软件管理</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .section { margin-bottom: 40px; }
        .nav { margin-bottom: 20px; text-align: center; }
        .nav a { margin-right: 15px; text-decoration: none; color: #007bff; font-weight: bold; }
        form { margin-bottom: 20px; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        textarea { min-height: 80px; resize: vertical; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; width: 100%; }
        button:hover { background-color: #0056b3; }
        .message { text-align: center; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .checkbox-group { display: flex; align-items: center; margin: 10px 0; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        .radio-group label { margin-right: 15px; }
        .radio-group input { width: auto; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/dashboard.html">生成卡密</a>
            <a href="/manage.html">管理卡密</a>
            <a href="/logs.html">使用日志</a>
            <a href="/software.html">软件管理</a>
            <a href="/admin.html" onclick="localStorage.removeItem('loggedin');">退出登录</a>
        </div>

        <!-- 远程公告 -->
        <div class="section">
            <h2>发布远程公告</h2>
            <form id="announcement-form">
                <label for="ann_title">公告标题:</label>
                <input type="text" id="ann_title" placeholder="输入公告标题" required>
                <label for="ann_content">公告内容:</label>
                <textarea id="ann_content" placeholder="输入公告内容，支持换行" required></textarea>
                <button type="submit">发布公告</button>
            </form>
            <div id="ann-message"></div>
        </div>

        <!-- 应用升级 -->
        <div class="section">
            <h2>发布新版本</h2>
            <form id="version-form">
                <label for="version_name">版本名称 (如: 1.2.0):</label>
                <input type="text" id="version_name" placeholder="例如: 1.2.0" required>
                <label for="version_code">版本号 (整数):</label>
                <input type="number" id="version_code" placeholder="例如: 3 (必须大于当前最新版本)" required>
                <label for="download_url">下载链接:</label>
                <input type="text" id="download_url" placeholder="APK或安装包的完整下载地址" required>
                <label for="update_log">更新日志:</label>
                <textarea id="update_log" placeholder="描述本次更新的内容，支持换行"></textarea>
                <div class="checkbox-group">
                    <input type="checkbox" id="is_force_update">
                    <label for="is_force_update">强制更新 (用户必须更新才能使用)</label>
                </div>
                <button type="submit">发布版本</button>
            </form>
            <div id="version-message"></div>
        </div>

        <!-- 应用配置 -->
        <div class="section">
            <h2>应用配置</h2>
            <form id="settings-form">
                <label>是否允许试用:</label>
                <div class="radio-group">
                    <label><input type="radio" name="allow_trial" value="true" required> 是</label>
                    <label><input type="radio" name="allow_trial" value="false" required> 否</label>
                </div>
                <label for="trial_duration_days">试用天数:</label>
                <input type="number" id="trial_duration_days" placeholder="例如: 3" required>
                <label for="app_entry_password">应用进入密码 (留空则无密码):</label>
                <input type="text" id="app_entry_password" placeholder="留空表示不需要密码">
                <label for="software_share_url">软件分享链接:</label>
                <input type="text" id="software_share_url" placeholder="用户分享软件时使用的链接" required>
                <button type="submit">保存配置</button>
            </form>
            <div id="settings-message"></div>
        </div>
    </div>

    <script>
    if (!localStorage.getItem('loggedin')) {
        window.location.href = '/admin.html';
    }

    function showMessage(elementId, message, isSuccess) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = `message ${isSuccess ? 'success' : 'error'}`;
        setTimeout(() => { el.textContent = ''; el.className = ''; }, 3000);
    }

    // 加载现有配置
    async function loadSettings() {
        const response = await fetch('/admin/settings');
        const result = await response.json();
        if (result.status === 'success') {
            const s = result.settings;
            document.querySelector(`input[name="allow_trial"][value="${s.allow_trial}"]`).checked = true;
            document.getElementById('trial_duration_days').value = s.trial_duration_days;
            document.getElementById('app_entry_password').value = s.app_entry_password || '';
            document.getElementById('software_share_url').value = s.software_share_url;
        }
    }

    // 发布公告
    document.getElementById('announcement-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('ann_title').value;
        const content = document.getElementById('ann_content').value;
        const response = await fetch('/admin/announcement', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content }) });
        const result = await response.json();
        showMessage('ann-message', result.message, result.status === 'success');
        if (result.status === 'success') e.target.reset();
    });

    // 发布版本
    document.getElementById('version-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = { version_name: document.getElementById('version_name').value, version_code: parseInt(document.getElementById('version_code').value), download_url: document.getElementById('download_url').value, update_log: document.getElementById('update_log').value, is_force_update: document.getElementById('is_force_update').checked };
        const response = await fetch('/admin/version', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const result = await response.json();
        showMessage('version-message', result.message, result.status === 'success');
        if (result.status === 'success') e.target.reset();
    });

    // 保存配置
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = { allow_trial: document.querySelector('input[name="allow_trial"]:checked').value, trial_duration_days: document.getElementById('trial_duration_days').value, app_entry_password: document.getElementById('app_entry_password').value, software_share_url: document.getElementById('software_share_url').value };
        const response = await fetch('/admin/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const result = await response.json();
        showMessage('settings-message', result.message, result.status === 'success');
    });

    // 页面加载时执行
    loadSettings();
    </script>
</body>
</html>
